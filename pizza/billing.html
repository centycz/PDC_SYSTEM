<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√öƒçtov√°n√≠ - P≈ôehled stol≈Ø</title>
    <style>
        /* Basic Layout */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #ff5858 0%, #f09819 100%); 
            min-height: 100vh; 
            padding: 20px; 
            margin: 0;
        }
        
        /* Header and Navigation */
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .header h1 { 
            color: white; 
            font-size: 2.5em; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .nav-links { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
        }
        .nav-link { 
            padding: 10px 20px; 
            background: rgba(255,255,255,0.2); 
            color: white; 
            text-decoration: none; 
            border-radius: 25px; 
            font-weight: 500; 
            transition: all 0.3s ease;
        }
        .nav-link:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px);
        }
        .nav-link.active { 
            background: white; 
            color: #ff5858;
        }

        /* Main Container */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .section-title { 
            font-size: 1.6em; 
            color: #ff5858; 
            margin: 25px 0 10px 0; 
            font-weight: bold;
        }
        .orders-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }

        /* Table Cards */
        .order-card { 
            border: 3px solid #ff5858; 
            border-radius: 15px; 
            padding: 20px; 
            background: #fff; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.07); 
            transition: transform 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
        }
        .order-card.fully-paid {
            border-color: #28a745;
        }
        .order-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #eee;
        }
        .table-number { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #f09819; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .paid-badge {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Bill Items */
        .order-items { 
            margin-bottom: 20px; 
        }
        .bill-list { 
            margin: 0 0 8px 0; 
            padding: 0; 
            list-style: none; 
        }
        .bill-item { 
            border-bottom: 1px solid #ffe4bf; 
            padding: 6px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .bill-item:last-child { 
            border-bottom: none;
        }
        .bill-name {
            font-weight: bold;
        }
        .bill-qty {
            color: #999;
        }
        .bill-note {
            font-size: 0.93em; 
            color: #b67100; 
            font-style: italic;
            display: block;
            margin-top: 3px;
        }
        .bill-total { 
            font-weight: bold; 
            color: #ff5858; 
            font-size: 1.1em; 
            text-align: right; 
            margin-top: 7px;
        }

        /* Buttons */
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .btn-pay { 
            background: #ff5858; 
            color: white; 
            margin-top: 9px;
        }
        .btn-pay:hover { 
            background: #f09819; 
        }
        .btn-reprint {
            background: #28a745; 
            color: white; 
            margin-top: 9px; 
            margin-left: 7px;
        }
        .btn-reprint:hover {
            background: #218838;
        }

        /* Modal Styles */
        .modal-bg { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0,0,0,0.6); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            background: #ff5858;
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            font-size: 1.3em;
            font-weight: bold;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Payment Modal Specific */
        .payment-mode-toggle {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ff5858;
        }
        .payment-mode-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .payment-mode-btn.active {
            background: #ff5858;
            color: white;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .items-table th,
        .items-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .items-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .split-qty-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .payment-method-group {
            margin: 15px 0;
        }
        .payment-method-group label {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
        }
        .payment-method-group input[type="radio"] {
            margin-right: 8px;
        }
        .employee-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
        .payment-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff5858;
            text-align: right;
            margin: 15px 0;
        }

        /* Footer */
        .last-update { 
            text-align: center; 
            color: #666; 
            font-size: 0.95em; 
            margin-top: 15px;
        }
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: #999;
        }
        .empty-state .icon { 
            font-size: 4em; 
            margin-bottom: 20px; 
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .orders-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                max-width: 95vw;
                margin: 10px;
            }
            .nav-links {
                gap: 8px;
            }
            .nav-link {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ √öƒçtov√°n√≠</h1>
        <div class="nav-links">
            <a href="index.html" class="nav-link" id="nav-obsluha">üè† Objedn√°vky</a>
            <a href="kitchen.html" class="nav-link" id="nav-kuchyn">üë®‚Äçüç≥ Kuchy≈à</a>
            <a href="pasta-kuchyn.html" class="nav-link " id="nav-pasta">üçù Pasta kuchy≈à</a>
            <a href="bar.html" class="nav-link" id="nav-bar">üç∫ Bar</a>
            <a href="serving.html" class="nav-link" id="nav-servirovani">üçΩÔ∏è Serv√≠rov√°n√≠</a>
            <a href="billing.html" class="nav-link active" id="nav-uctovani">üí∞ √öƒçtov√°n√≠</a>
            <a href="historie.html" class="nav-link">üìã Historie</a>
        </div>
    </div>
    <div class="container">
        <div class="section-title">Aktu√°ln√≠ obsazen√© stoly s objedn√°vkami</div>
        <div class="orders-grid" id="ordersContainer"></div>
        <div class="last-update">Posledn√≠ aktualizace: <span id="lastUpdate">-</span></div>
    </div>

    <!-- Global Modal Container -->
    <div id="modal-bg" class="modal-bg" style="display:none"></div>

    <script>
        const API = 'api/restaurant-api.php';
        let tables = [];
        let currentTableData = null;
        
        // Unified Payment Modal Object
        const billPay = {
            currentTable: null,
            items: [],
            paymentMode: 'full', // 'full' or 'partial'
            
            // Show payment modal for a table
            show: function(tableData) {
                this.currentTable = tableData;
                this.items = this.aggregateItems(tableData.billItems || []);
                this.renderModal();
                this.setPaymentMode('full');
                this.prefillEmployee();
                document.getElementById('modal-bg').style.display = 'flex';
            },
            
            // Aggregate items by name|unit_price|note
            aggregateItems: function(items) {
                const itemMap = new Map();
                
                items.forEach(item => {
                    const outstandingQty = this.getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity') || 0;
                    if (outstandingQty <= 0) return;
                    
                    const itemId = this.getItemValue(item, 'id', 'order_item_id');
                    const itemName = this.getItemValue(item, 'item_name', 'name') || '';
                    const unitPrice = parseFloat(this.getItemValue(item, 'unit_price', 'price')) || 0;
                    const note = this.getItemValue(item, 'note', 'note') || '';
                    
                    const key = `${itemName}_${unitPrice}_${note}`;
                    
                    if (itemMap.has(key)) {
                        const existing = itemMap.get(key);
                        existing.qty_outstanding += parseInt(outstandingQty);
                        existing.ids.push(itemId);
                    } else {
                        itemMap.set(key, {
                            name: itemName,
                            unit_price: unitPrice,
                            qty_outstanding: parseInt(outstandingQty),
                            note: note,
                            ids: [itemId],
                            aggregated: true
                        });
                    }
                });
                
                return Array.from(itemMap.values());
            },
            
            // Render the payment modal
            renderModal: function() {
                const modalBg = document.getElementById('modal-bg');
                const tableCode = this.currentTable.table_code || this.currentTable.table_number;
                
                modalBg.innerHTML = `
                    <div class="modal-content" style="width: 800px;">
                        <div class="modal-header">
                            PLATBA - St≈Øl ${tableCode}
                        </div>
                        <div class="modal-body">
                            <div class="payment-mode-toggle">
                                <button class="payment-mode-btn active" onclick="billPay.setPaymentMode('full')" id="mode-full">
                                    Pln√° platba
                                </button>
                                <button class="payment-mode-btn" onclick="billPay.setPaymentMode('partial')" id="mode-partial">
                                    ƒå√°steƒçn√° platba
                                </button>
                            </div>
                            
                            <div id="items-section">
                                <h4 id="payment-qty-header">Pln√° platba</h4>
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th>Polo≈æka</th>
                                            <th>Cena</th>
                                            <th>Dostupn√©</th>
                                            <th>K √∫hradƒõ</th>
                                            <th>Celkem</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-tbody">
                                        ${this.generateItemsHTML()}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="payment-method-group">
                                <h4>Zp≈Øsob platby:</h4>
                                <label>
                                    <input type="radio" name="payment-method" value="cash" checked>
                                    Hotovost
                                </label>
                                <label>
                                    <input type="radio" name="payment-method" value="card">
                                    Karta
                                </label>
                            </div>
                            
                            <div>
                                <label for="employee-name"><strong>Obsluha:</strong></label>
                                <input type="text" class="employee-input" id="employee-name" placeholder="Jm√©no obsluhy">
                            </div>
                            
                            <div class="payment-total" id="payment-total">
                                Celkem k √∫hradƒõ: 0 Kƒç
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn" style="background: #6c757d; color: white;" onclick="billPay.close()">
                                Zru≈°it
                            </button>
                            <button class="btn btn-pay" onclick="billPay.confirmPayment()" id="confirm-payment-btn">
                                Zaplatit
                            </button>
                        </div>
                    </div>
                `;
                
                this.setupQuantityListeners();
                this.updateTotals();
            },
            
            // Generate HTML for aggregated items
            generateItemsHTML: function() {
                return this.items.map((item, idx) => {
                    const itemIds = item.ids.join(',');
                    const noteHtml = item.note ? `<br><small style="color: #666; font-style: italic;">${item.note}</small>` : '';
                    
                    return `
                        <tr>
                            <td>
                                ${item.name}
                                ${noteHtml}
                            </td>
                            <td>${this.formatCurrency(item.unit_price)}</td>
                            <td>${item.qty_outstanding}√ó</td>
                            <td>
                                <input type="number" class="split-qty-input" min="0" max="${item.qty_outstanding}" value="0" 
                                       data-item-ids="${itemIds}" data-unit-price="${item.unit_price}" data-index="${idx}">
                            </td>
                            <td>
                                <span class="item-total" id="item-total-${idx}">0 Kƒç</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            // Set payment mode (full/partial)
            setPaymentMode: function(mode) {
                this.paymentMode = mode;
                
                // Update button states
                document.getElementById('mode-full').classList.toggle('active', mode === 'full');
                document.getElementById('mode-partial').classList.toggle('active', mode === 'partial');
                
                // Update inputs
                const inputs = document.querySelectorAll('.split-qty-input');
                const header = document.getElementById('payment-qty-header');
                
                if (mode === 'full') {
                    inputs.forEach(input => {
                        input.value = input.max;
                        input.disabled = true;
                    });
                    if (header) header.textContent = 'Pln√° platba';
                } else {
                    inputs.forEach(input => {
                        input.value = 0;
                        input.disabled = false;
                    });
                    if (header) header.textContent = 'K √∫hradƒõ';
                }
                
                this.updateTotals();
            },
            
            // Setup quantity input listeners
            setupQuantityListeners: function() {
                document.querySelectorAll('.split-qty-input').forEach(input => {
                    input.addEventListener('input', () => this.updateTotals());
                    input.addEventListener('change', () => this.updateTotals());
                });
            },
            
            // Update payment totals
            updateTotals: function() {
                const qtyInputs = document.querySelectorAll('.split-qty-input');
                let total = 0;
                
                qtyInputs.forEach((input, index) => {
                    const qty = parseInt(input.value) || 0;
                    const unitPrice = parseFloat(input.dataset.unitPrice) || 0;
                    const itemTotal = qty * unitPrice;
                    
                    total += itemTotal;
                    
                    const totalSpan = document.getElementById(`item-total-${index}`);
                    if (totalSpan) {
                        totalSpan.textContent = this.formatCurrency(itemTotal);
                    }
                });
                
                const totalElement = document.getElementById('payment-total');
                if (totalElement) {
                    totalElement.textContent = `Celkem k √∫hradƒõ: ${this.formatCurrency(total)}`;
                }
            },
            
            // Pre-fill employee name
            prefillEmployee: function() {
                const employeeInput = document.getElementById('employee-name');
                if (!employeeInput) return;
                
                const storedEmployee = localStorage.getItem('employee_name');
                if (storedEmployee && storedEmployee.trim()) {
                    employeeInput.value = storedEmployee.trim();
                    return;
                }
                
                // Fallback to session API
                this.fetchSessionEmployee().then(name => {
                    if (name) {
                        employeeInput.value = name;
                        localStorage.setItem('employee_name', name);
                    }
                });
                
                // Save on blur
                employeeInput.addEventListener('blur', function() {
                    const name = this.value.trim();
                    if (name) {
                        localStorage.setItem('employee_name', name);
                    }
                });
            },
            
            // Fetch employee from session
            fetchSessionEmployee: async function() {
                try {
                    const response = await fetch('/pizza/api/get-session-user.php');
                    if (response.ok) {
                        const data = await response.json();
                        return data.success && data.full_name ? data.full_name : null;
                    }
                } catch (error) {
                    console.log('Could not fetch session user info:', error);
                }
                return null;
            },
            
            // Confirm payment
            confirmPayment: async function() {
                const confirmBtn = document.getElementById('confirm-payment-btn');
                const originalText = confirmBtn.textContent;
                
                try {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'VYSTAVUJE SE...';
                    
                    // Get payment details
                    const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'cash';
                    const employeeName = document.getElementById('employee-name')?.value?.trim() || '';
                    
                    if (!employeeName) {
                        alert('Pros√≠m zadejte jm√©no obsluhy');
                        return;
                    }
                    
                    // Build payment data
                    const paymentData = {
                        table_number: this.currentTable.table_number,
                        payment_method: paymentMethod,
                        employee_name: employeeName,
                        print: true
                    };
                    
                    if (this.paymentMode === 'full') {
                        // Full payment - empty items array
                        paymentData.items = [];
                    } else {
                        // Partial payment - sequential allocation
                        paymentData.items = this.buildPartialPaymentItems();
                    }
                    
                    // Validate partial payment has items
                    if (this.paymentMode === 'partial' && paymentData.items.length === 0) {
                        alert('Pro ƒç√°steƒçnou platbu mus√≠te vybrat alespo≈à jednu polo≈æku');
                        return;
                    }
                    
                    // Send payment request
                    const response = await fetch(`${API}?action=create-receipt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paymentData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Fire-and-forget proxy print
                        this.proxyPrint(result.data.receipt_number);
                        
                        alert(`√öspƒõ≈°nƒõ zaplaceno! √öƒçtenka #${result.data.receipt_number}`);
                        this.close();
                        loadTables(); // Refresh tables
                    } else {
                        throw new Error(result.message || 'Nezn√°m√° chyba');
                    }
                    
                } catch (error) {
                    console.error('Payment error:', error);
                    alert('Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky: ' + error.message);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            },
            
            // Build partial payment items
            buildPartialPaymentItems: function() {
                const items = [];
                const inputs = document.querySelectorAll('.split-qty-input');
                
                inputs.forEach(input => {
                    const payQty = parseInt(input.value) || 0;
                    if (payQty <= 0) return;
                    
                    const itemIds = input.dataset.itemIds.split(',').map(id => parseInt(id));
                    
                    // Sequential allocation logic
                    let remainingQty = payQty;
                    itemIds.forEach(itemId => {
                        if (remainingQty <= 0) return;
                        
                        items.push({
                            order_item_id: itemId,
                            pay_qty: Math.min(remainingQty, 1) // Allocate 1 by 1 sequentially
                        });
                        remainingQty -= 1;
                    });
                });
                
                return items;
            },
            
            // Fire-and-forget proxy print
            proxyPrint: function(receiptNumber) {
                try {
                    fetch(`${API}?action=proxy-print`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            doc_type: 'receipt',
                            receipt_number: receiptNumber
                        })
                    }).catch(err => {
                        console.warn('Proxy print failed (non-critical):', err);
                    });
                } catch (error) {
                    console.warn('Proxy print error (non-critical):', error);
                }
            },
            
            // Reprint last receipt for fully paid table
            reprintLast: async function(tableNumber) {
                try {
                    const billResponse = await fetch(`${API}?action=get-bill&table=${tableNumber}`);
                    const billResult = await billResponse.json();
                    
                    if (billResult.success && billResult.data.prior_receipts && billResult.data.prior_receipts.length > 0) {
                        const lastReceipt = billResult.data.prior_receipts[0];
                        const receiptNumber = this.getItemValue(lastReceipt, 'receipt_number', 'id');
                        
                        if (receiptNumber) {
                            const response = await fetch(`${API}?action=reprint-receipt&receipt_number=${receiptNumber}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ print: true })
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                alert(`√öƒçtenka #${receiptNumber} byla odesl√°na na tisk`);
                            } else {
                                alert('Chyba p≈ôi reprinting: ' + (result.message || 'Nezn√°m√° chyba'));
                            }
                        } else {
                            alert('Nenalezen ƒç√≠slo √∫ƒçtenky pro reprint');
                        }
                    } else {
                        alert('≈Ω√°dn√© p≈ôedchoz√≠ √∫ƒçtenky nenalezeny pro tento st≈Øl');
                    }
                } catch (error) {
                    console.error('Reprint error:', error);
                    alert('Chyba p≈ôi reprint: ' + error.message);
                }
            },
            
            // Close modal
            close: function() {
                document.getElementById('modal-bg').style.display = 'none';
                document.getElementById('modal-bg').innerHTML = '';
                this.currentTable = null;
            },
            
            // Utility functions
            getItemValue: function(item, ...keys) {
                for (const key of keys) {
                    if (item && item.hasOwnProperty(key) && item[key] !== null && item[key] !== undefined) {
                        return item[key];
                    }
                }
                return null;
            },
            
            formatCurrency: function(amount) {
                return new Intl.NumberFormat('cs-CZ', {
                    style: 'currency',
                    currency: 'CZK',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount).replace(/\s/g, ' ');
            }
        };
        
        // Table loading and display functions
        async function loadTables() {
            try {
                updateLastUpdateTime();
                
                const tRes = await fetch(`${API}?action=tables`);
                const allTables = (await tRes.json()).data || [];
                
                const filteredTables = [];
                
                for (const table of allTables) {
                    // Single get-bill call per table
                    const billRes = await fetch(`${API}?action=get-bill&table=${table.table_number}`);
                    let outstandingItems = [];
                    let hasAnyItems = false;
                    
                    try {
                        const bill = await billRes.json();
                        if (bill.success && bill.data) {
                            hasAnyItems = bill.data.items && bill.data.items.length > 0;
                            
                            if (bill.data.items) {
                                outstandingItems = bill.data.items.filter(item => {
                                    const outstandingQty = billPay.getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity');
                                    return outstandingQty > 0;
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Error loading bill for table', table.table_number, ':', e);
                    }
                    
                    // Include table if it has any items (outstanding or fully paid)
                    if (hasAnyItems) {
                        table.billItems = outstandingItems;
                        table.outstandingAmount = outstandingItems.reduce((sum, item) => {
                            const outstandingQty = billPay.getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity') || 0;
                            const unitPrice = parseFloat(billPay.getItemValue(item, 'unit_price', 'price')) || 0;
                            return sum + (unitPrice * outstandingQty);
                        }, 0);
                        table.fullyPaid = outstandingItems.length === 0;
                        
                        filteredTables.push(table);
                    }
                }
                
                renderTables(filteredTables);
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }
        
        function renderTables(tables) {
            const container = document.getElementById('ordersContainer');
            
            if (!tables || tables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üìã</span>
                        <p>≈Ω√°dn√© aktivn√≠ stoly s objedn√°vkami</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tables.map(table => {
                const tableCode = table.table_code || table.table_number;
                const isFullyPaid = table.fullyPaid;
                const outstandingAmount = table.outstandingAmount || 0;
                
                const itemsHtml = table.billItems && table.billItems.length > 0 ? 
                    generateBillItemsHTML(table.billItems) : 
                    '<div style="color: #28a745; font-style: italic;">V≈°e uhrazeno</div>';
                
                const paymentButtons = isFullyPaid ? 
                    `<button class="btn btn-reprint" onclick="billPay.reprintLast(${table.table_number})">
                        üìÑ Reprint
                    </button>` :
                    `<button class="btn btn-pay" onclick="billPay.show(tables.find(t => t.table_number === ${table.table_number}))">
                        üí∞ Zaplatit
                    </button>`;
                
                return `
                    <div class="order-card ${isFullyPaid ? 'fully-paid' : ''}">
                        <div class="order-header">
                            <div class="table-number">
                                üçΩÔ∏è St≈Øl ${tableCode}
                                ${isFullyPaid ? '<span class="paid-badge">Uhrazeno</span>' : ''}
                            </div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        ${!isFullyPaid ? 
                            `<div class="bill-total">Celkem: ${billPay.formatCurrency(outstandingAmount)}</div>` : 
                            ''}
                        ${paymentButtons}
                    </div>
                `;
            }).join('');
            
            // Store tables globally for access in onclick handlers
            window.tables = tables;
        }
        
        function generateBillItemsHTML(items) {
            const aggregatedItems = billPay.aggregateItems(items);
            
            if (aggregatedItems.length === 0) {
                return '<div style="color: #28a745; font-style: italic;">V≈°e uhrazeno</div>';
            }
            
            return `
                <ul class="bill-list">
                    ${aggregatedItems.map(item => {
                        const noteHtml = item.note ? `<span class="bill-note">${item.note}</span>` : '';
                        return `
                            <li class="bill-item">
                                <div>
                                    <span class="bill-name">${item.name}</span>
                                    <span class="bill-qty">(${item.qty_outstanding}√ó ${billPay.formatCurrency(item.unit_price)})</span>
                                    ${noteHtml}
                                </div>
                                <div>${billPay.formatCurrency(item.qty_outstanding * item.unit_price)}</div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }
        
        function updateLastUpdateTime() {
            const element = document.getElementById('lastUpdate');
            if (element) {
                element.textContent = new Date().toLocaleTimeString();
            }
        }
        
        // Initialize and start periodic refresh
        loadTables();
        setInterval(() => {
            // Only refresh if no modal is open
            if (document.getElementById('modal-bg').style.display === 'none') {
                loadTables();
            }
        }, 7000);
        
        // Global functions for onclick handlers
        window.billPay = billPay;
    </script>
</body>
</html>